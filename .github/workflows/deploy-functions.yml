name: ğŸš€ Deploy ServiMapp Functions - Complete

on:
  push:
    branches: [ main, master ]
    paths: 
      - 'functions/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Tipo de deployment'
        required: true
        default: 'functions'
        type: choice
        options:
        - functions
        - full
        - hosting
        - firestore

jobs:
  deploy-functions:
    name: ğŸ”¥ Deploy Cloud Functions (85+ Functions)
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js 22.x
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies (Root)
      run: npm ci
      
    - name: ğŸ“¦ Install Functions Dependencies
      run: |
        cd functions
        npm ci
        
    - name: ğŸ”¨ Build TypeScript Functions
      run: |
        cd functions
        npm run build
        
    - name: ğŸ“‹ List Compiled Functions
      run: |
        echo "=== FUNCIONES COMPILADAS ==="
        ls -la functions/lib/
        echo "=== EXPORTS EN INDEX.JS ==="
        grep -c "exports\." functions/lib/index.js || echo "Verificando exports..."
        
    - name: ğŸ”§ Setup Firebase CLI
      run: |
        npm install -g firebase-tools@latest
        firebase --version
        
    - name: ğŸ¯ Authenticate with Firebase
      run: |
        echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > $HOME/firebase-service-account.json
        firebase use servimap-nyniz --token "${{ secrets.FIREBASE_TOKEN }}"
      env:
        GOOGLE_APPLICATION_CREDENTIALS: $HOME/firebase-service-account.json
        
    - name: ğŸš€ Deploy Cloud Functions (All 85+ Functions)
      run: |
        echo "ğŸš€ Desplegando TODAS las Cloud Functions de ServiMapp..."
        echo "ğŸ“Š Funciones a desplegar:"
        echo "  - Sistema de Pagos (13 funciones)"
        echo "  - Sistema de Comunidades (14 funciones)" 
        echo "  - Sistema Premium (19 funciones)"
        echo "  - Sistema de Emergencias (5 funciones)"
        echo "  - Sistema de ModeraciÃ³n IA (4 funciones)"
        echo "  - Sistema de Embajadores (4 funciones)"
        echo "  - Sistema de Notificaciones (6 funciones)"
        echo "  - Sistema de Videollamadas (4 funciones)"
        echo "  - Sistema de Chat (5 funciones)"
        echo "  - Y muchas mÃ¡s..."
        
        firebase deploy --only functions --project servimap-nyniz --token "${{ secrets.FIREBASE_TOKEN }}" --force
        
    - name: âœ… Verify Deployment
      run: |
        echo "ğŸ” Verificando funciones desplegadas..."
        firebase functions:list --project servimap-nyniz --token "${{ secrets.FIREBASE_TOKEN }}"
        
    - name: ğŸ“ Update Documentation
      run: |
        echo "ğŸ“ Deployment completado el $(date)"
        echo "âœ… ServiMapp Functions: TODAS ACTIVAS"
        echo "ğŸŒ URL: https://servimap-nyniz.web.app"
        
  deploy-full:
    name: ğŸŒŸ Full Deployment (Optional)
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_type == 'full'
    needs: [deploy-functions]
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ”§ Setup Firebase CLI
      run: npm install -g firebase-tools@latest
      
    - name: ğŸ¯ Authenticate with Firebase
      run: |
        echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > firebase-service-account.json
        firebase use servimap-nyniz --token "${{ secrets.FIREBASE_TOKEN }}"
        
    - name: ğŸš€ Deploy Everything
      run: |
        echo "ğŸš€ Deployment completo: Hosting + Storage + Firestore + Functions"
        firebase deploy --project servimap-nyniz --token "${{ secrets.FIREBASE_TOKEN }}" --force
        
    - name: ğŸ‰ Success Notification
      run: |
        echo "ğŸ‰ DEPLOYMENT COMPLETO EXITOSO!"
        echo "âœ… ServiMapp estÃ¡ 100% desplegada con todas las funcionalidades"
        echo "ğŸŒ URL: https://servimap-nyniz.web.app"
        echo "âš¡ Total Functions: 85+"
        echo "ğŸ’³ Pagos: Stripe integrado"
        echo "ğŸ¤– IA: OpenAI integrada" 
        echo "ğŸ“± PWA: Completamente instalable"